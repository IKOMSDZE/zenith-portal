
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- Helper Functions ---
    
    function isSignedIn() {
      return request.auth != null;
    }

    // Fetches the user document from the 'users' collection using the Auth UID as the key.
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function isAdmin() {
      return isSignedIn() && getUserData().role == 'Admin';
    }

    function isManager() {
      return isSignedIn() && getUserData().role == 'Manager';
    }

    function isHR() {
      return isSignedIn() && getUserData().role == 'HR';
    }

    function isAccountant() {
      return isSignedIn() && getUserData().role == 'Accountant';
    }

    // Checks if the document belongs to the authenticated user
    function isOwner(data) {
      return isSignedIn() && data.employeeId == getUserData().id;
    }

    // --- Collection Rules ---

    // 1. Users
    match /users/{userId} {
      allow read: if isSignedIn() && (request.auth.uid == userId || isAdmin() || isManager() || isHR());
      allow write: if isAdmin() || (isSignedIn() && request.auth.uid == userId);
    }

    // 2. Attendance
    match /attendance/{id} {
      allow read: if isSignedIn() && (isAdmin() || isManager() || isOwner(resource.data));
      allow create: if isSignedIn();
      allow update, delete: if isAdmin() || isOwner(resource.data);
    }

    // 3. Vacations
    match /vacations/{id} {
      allow read: if isSignedIn() && (isAdmin() || isManager() || isHR() || isOwner(resource.data));
      allow create: if isSignedIn();
      allow update, delete: if isAdmin() || isManager() || isHR();
    }

    // 4. Branches
    match /branches/{branchId} {
      allow read: if isSignedIn();
      allow write: if isAdmin() || (isManager() && getUserData().branch == branchId);
    }

    // 5. System Settings
    match /settings/{docId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    // 6. Branch Balances & Cash History
    match /branchBalances/{branchId} {
      allow read: if isSignedIn() && (isAdmin() || isManager() || isAccountant());
      allow write: if isSignedIn() && (isAdmin() || isManager() || getUserData().branch == branchId);
    }

    match /cashHistory/{id} {
      allow read: if isSignedIn() && (isAdmin() || isManager() || isAccountant());
      allow create: if isSignedIn();
      allow update, delete: if isAdmin() || isAccountant();
    }

    // 7. SMS Logs
    match /smsLogs/{id} {
      allow read, write: if isAdmin();
    }

    // Default
    match /{document=**} {
      allow read, write: if isAdmin();
    }
  }
}
